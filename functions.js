const sdk=new window.sfdc.BlockSDK({blockEditorWidth:600});document.addEventListener("DOMContentLoaded",function(){const buttons=document.querySelectorAll(".slds-button_icon");buttons.forEach(button=>{const tooltip=button.closest("div").querySelector(".tooltip");let showTimeout;button.addEventListener("mouseenter",function(){showTimeout=setTimeout(()=>{tooltip.style.display="block"},1e3)});button.addEventListener("mouseleave",function(){clearTimeout(showTimeout);tooltip.style.display="none"});tooltip.addEventListener("mouseenter",function(){tooltip.style.display="block"});tooltip.addEventListener("mouseleave",function(){tooltip.style.display="none"})})});function sanitizeForAmpVar(str){return str.replace(/[^a-zA-Z0-9_]/g,"")}document.addEventListener("DOMContentLoaded",function(){setupToggles();sdk.getData(function(data){if(!data.configured){const unconfiguredPreview=`<table border="0" style="width: 100%; border-collapse: collapse; background-color:rgb(230, 230, 230); margin: auto; background-color:rgb(230, 230, 230);"><tr><td style="text-align: center; padding: 10px 2px 10px 2px; font-size: 14px; background-color:rgb(230, 230, 230);color:rgb(0, 0, 0); font-family: Arial, Helvetica, sans-serif;"><b>Please configure the block to use it</b></td></tr></table>`;sdk.setSuperContent(unconfiguredPreview)}document.getElementById("promotionfromvariable").checked=data.promotionfromvariable||false;document.getElementById("promotion").value=data.promotion||"";document.getElementById("discountcodetoggle").checked=data.discountcodetoggle||false;document.getElementById("discountcodefromvariable").checked=data.discountcodefromvariable||false;document.getElementById("discountcode").value=data.discountcode||"";document.getElementById("expirationtoggle").checked=data.expirationtoggle||false;document.getElementById("expirationfromvariable").checked=data.expirationfromvariable||false;document.getElementById("expirationvariable").value=data.expirationvariable||"";document.getElementById("expiration").value=data.expiration||"";updateFieldVisibility()})});function setupToggles(){const toggles=["promotionfromvariable","discountcodefromvariable","expirationfromvariable","discountcodetoggle","expirationtoggle"];toggles.forEach(id=>{document.getElementById(id).addEventListener("change",updateFieldVisibility)});updateFieldVisibility()}const inputs=document.querySelectorAll("input");inputs.forEach(input=>{input.addEventListener("input",()=>{updateFieldVisibility();saveData()})});function updateFieldVisibility(){document.getElementById("promotionatsymbol").style.display=document.getElementById("promotionfromvariable").checked?"inline":"none";document.getElementById("discountcodeatsymbol").style.display=document.getElementById("discountcodefromvariable").checked?"inline":"none";const isExpirationFromVar=document.getElementById("expirationfromvariable").checked;document.getElementById("expirationvariablewrapper").style.display=isExpirationFromVar?"inline":"none";document.getElementById("expirationcalendarwrapper").style.display=isExpirationFromVar?"none":"inline";const discountWrapper=document.getElementById("discountwrapper");const isDiscountEnabled=document.getElementById("discountcodetoggle").checked;if(discountWrapper){discountWrapper.style.display=isDiscountEnabled?"block":"none"}const expirationWrapper=document.getElementById("expirationwrapper");const isExpirationEnabled=document.getElementById("expirationtoggle").checked;if(expirationWrapper){expirationWrapper.style.display=isExpirationEnabled?"block":"none"}}function formatDateToISOWithOffset(dateStr,offset="+02:00"){const date=new Date(dateStr);if(isNaN(date))return"";const pad=num=>String(num).padStart(2,"0");const year=date.getFullYear();const month=pad(date.getMonth()+1);const day=pad(date.getDate());const hours=pad(date.getHours());const minutes=pad(date.getMinutes());const seconds=pad(date.getSeconds());return`${year}-${month}-${day}T${hours}:${minutes}:${seconds}${offset}`}function saveData(){const data={promotionfromvariable:document.getElementById("promotionfromvariable").checked,promotion:document.getElementById("promotion").value,discountcodetoggle:document.getElementById("discountcodetoggle").checked,discountcodefromvariable:document.getElementById("discountcodefromvariable").checked,discountcode:document.getElementById("discountcode").value,expirationtoggle:document.getElementById("expirationtoggle").checked,expirationfromvariable:document.getElementById("expirationfromvariable").checked,expirationvariable:document.getElementById("expirationvariable").value,expiration:document.getElementById("expiration").value,configured:true};function generateEmailPreview(data){if(!data.promotion||String(data.promotion).trim().length===0){return'<table border="0" style="width: 100%; border-collapse: collapse; background-color:rgb(230, 230, 230); margin: auto; background-color:rgb(230, 230, 230);"><tr><td style="text-align: center; padding: 10px 2px 10px 2px; font-size: 14px; background-color:rgb(230, 230, 230);color:rgb(0, 0, 0); font-family: Arial, Helvetica, sans-serif;"><b>Promotion text cannot be empty</b></td></tr></table>'}const svgTagUrl=window.location.origin+"/gmailpromotionblock/tag.svg";const svgTag=`<img src="${svgTagUrl}" alt="Tag" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px; filter: invert(40%) sepia(40%) saturate(1000%) hue-rotate(100deg) brightness(80%) contrast(85%);" />`;const promotionText=data.promotionfromvariable?"AMPscript variable @"+sanitizeForAmpVar(data.promotion):data.promotion;const discountText=data.discountcodefromvariable?"AMPscript variable @"+sanitizeForAmpVar(data.discountcode):data.discountcode;let previewContent=`
      <center><span style="font-family: 'Roboto', Arial, Helvetica, sans-serif; font-size: 12px; font-weight: bold;">Preview of Gmail promotion tab</span><br>
      <span style="font-family: 'Roboto', Arial, Helvetica, sans-serif; font-size: 9px;"><i>This will NOT affect the content of your email</i></span>
      <br>
      <span style="font-family: 'Roboto', Arial, Helvetica, sans-serif; font-size: 9px;"><i>Place this block as high as possible in the mail, but if you use variables, ensure they are defined before the block.</i></span></center>
    <div style="display: flex; align-items: center; padding: 10px; background-color: #eee; border: 1px solid #ddd; max-width: 600px; margin: auto;">
        <div style="width: 50px; height: 50px; overflow: hidden; border-radius: 50%; margin-right: 15px;">
          <img src="https://image.email.imerco.dk/lib/fe2c117373640479731778/m/1/c0ba2568-fa65-442a-a95d-79114d523f11.png" alt="Sender Logo" style="width: 100%; height: 100%; object-fit: cover;" />
        </div>
        <div>
          <div style="font-family: 'Roboto', Arial, Helvetica, sans-serif; font-size: 13px; font-weight: bold;">Sendername</div>
          <div style="font-family: 'Roboto', Arial, Helvetica, sans-serif; font-size: 11px; font-weight: bold; color: #555;" >Subjectline</div>
          <div style="color: green; font-size: 14px; display: inline-block;">
             ${svgTag}${promotionText}
          </div>`;if(data.discountcodetoggle&&data.discountcode.trim().length>0){previewContent+=` <div style="color: darkgrey; font-size: 14px; display: inline-block; margin-left: 10px;">
            - Code: ${discountText}
          </div>`}if(data.expirationtoggle){const expiration=data.expirationfromvariable?data.expirationvariable:data.expiration;if(expiration&&expiration.trim().length>0){if(data.expirationfromvariable){previewContent+=`<div style="margin-top: 10px; padding-top: 0px; font-size: 12px; color: #D56E0C;">
          AMPscript variable @${data.expirationvariable}
        </div>`}else{previewContent+=`<div style="margin-top: 10px; padding-top: 0px; font-size: 12px; color: ${getExpirationColor(data.expiration)};">
          ${getExpirationText(data.expiration)}
        </div>`}}}previewContent+=`</div>
      </div>
    `;return previewContent}function getExpirationText(expirationDate){const now=new Date;const expiration=new Date(expirationDate);if(expiration<now){return"Expired"}const startOfToday=new Date(now.getFullYear(),now.getMonth(),now.getDate());const startOfExpiration=new Date(expiration.getFullYear(),expiration.getMonth(),expiration.getDate());const diffTime=startOfExpiration-startOfToday;const diffDays=Math.round(diffTime/(1e3*60*60*24));if(diffDays===0){return"Expires today"}else if(diffDays===1){return"Expires tomorrow"}else{return`Expires in ${diffDays} days`}}function getExpirationColor(expirationDate){const now=new Date;const expiration=new Date(expirationDate);if(expiration<now){return"grey"}else{return"#D56E0C"}}sdk.setData(data);const emailPreview=generateEmailPreview(data);let content="";if(data.promotion&&data.promotion.trim().length>0){content=`%%[ 
              SET @gp_promotionfromvariable = "${data.promotionfromvariable}"
                IF @gp_promotionfromvariable == "true" THEN
                  SET @gp_promotion = "%%=v(@${sanitizeForAmpVar(data.promotion)})=%%"
                    IF EMPTY (@${sanitizeForAmpVar(data.promotion)}) THEN
                      RaiseError("AMPscript variable chosen for promotion (@${sanitizeForAmpVar(data.promotion)}) is not set. Please ensure the variable is set BEFORE the Gmail promo block. You should place the block as high in the email as possible, but below the place where the variable is set. If you place it too low, Gmail may ignore it.", true)
                    ENDIF
                ELSE
                   SET @gp_promotion = "${data.promotion}"
                ENDIF
                ]%%
              <div itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="logo" content="https://image.email.imerco.dk/lib/fe2c117373640479731778/m/1/c0ba2568-fa65-442a-a95d-79114d523f11.png" />
              </div> 
              <div itemscope itemtype="http://schema.org/DiscountOffer">
                <meta itemprop="description" content="%%=treatascontent(@gp_promotion)=%%" />`;if(data.discountcodetoggle&&data.discountcode.trim().length>0){content+=`
              %%[SET @gp_discountcodefromvariable = "${data.discountcodefromvariable}"
                IF @gp_discountcodefromvariable == "true" THEN
                  SET @gp_discountcode = "%%=v(@${sanitizeForAmpVar(data.discountcode)})=%%"
                    IF EMPTY (@${sanitizeForAmpVar(data.discountcode)}) THEN
                      RaiseError("AMPscript variable chosen for discount code (@${sanitizeForAmpVar(data.discountcode)}) is not set. Please ensure the variable is set BEFORE the Gmail promo block. You should place the block as high in the email as possible, but below the place where the variable is set. If you place it too low, Gmail may ignore it.", true)
                    ENDIF
                ELSE
                   SET @gp_discountcode = "${data.discountcode}"
                ENDIF]%%            
              <meta itemprop="discountCode" content="%%=treatascontent(@gp_discountcode)=%%" />`}if(data.expirationtoggle){const expiration=data.expiration;const formattedDate=formatDateToISOWithOffset(expiration,"+02:00");if(data.expirationfromvariable===true&&String(data.expirationvariable).trim().length>0){content+=`
                  %%[ 
                    SET @gp_expiration = "%%=v(@${data.expirationvariable})=%%"
                    IF EMPTY (@${data.expirationvariable}) THEN
                      RaiseError("AMPscript variable chosen for expiration (@${data.expirationvariable}) is not set. Please ensure the variable is set BEFORE the Gmail promo block. You should place the block as high in the email as possible, but below the place where the variable is set. If you place it too low, Gmail may ignore it.", true)
                    ENDIF
                  ]%%
                  <meta itemprop="availabilityEnds" content="%%=treatascontent(@gp_expiration)=%%" />
                `}else{content+=`<meta itemprop="availabilityEnds" content="${formattedDate}" />`}}content+=`</div>`}sdk.setSuperContent(emailPreview);sdk.setContent(content)}